name: Publish to npm (version branches)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read

jobs:
  publish:
    name: Build and Publish
    runs-on: ubuntu-latest
    steps:
      # 拉取代码
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 解析标签类型并设定预期分支与 npm dist-tag
      # 规则：
      # - 正式版：vX.Y.Z -> 仅当该提交在 version/vX.Y.Z 分支上时发布，dist-tag=latest
      # - 预发布：vX.Y.Z-dev.N 或 vX.Y.Z-beta.N -> 仅当该提交在 version/vX.Y.Z 分支上时发布，dist-tag=dev/beta
      - name: Classify tag and prepare env
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Detected tag: $TAG"

          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # 正式版：vX.Y.Z
            VERSION="${TAG#v}"
            echo "PUBLISH_TAG=latest" >> "$GITHUB_ENV"
            echo "EXPECTED_BRANCH=version/${VERSION}" >> "$GITHUB_ENV"
            echo "SHOULD_PUBLISH=true" >> "$GITHUB_ENV"
            echo "Version type: Release"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-dev\.[0-9]+$ ]]; then
            # dev 预发布：vX.Y.Z-dev.N
            VERSION="${TAG%-dev*}"
            VERSION="${VERSION#v}"
            echo "PUBLISH_TAG=dev" >> "$GITHUB_ENV"
            echo "EXPECTED_BRANCH=version/${VERSION}" >> "$GITHUB_ENV"
            echo "SHOULD_PUBLISH=true" >> "$GITHUB_ENV"
            echo "Version type: Dev Pre-release"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-beta\.[0-9]+$ ]]; then
            # beta 预发布：vX.Y.Z-beta.N
            VERSION="${TAG%-beta*}"
            VERSION="${VERSION#v}"
            echo "PUBLISH_TAG=beta" >> "$GITHUB_ENV"
            echo "EXPECTED_BRANCH=version/${VERSION}" >> "$GITHUB_ENV"
            echo "SHOULD_PUBLISH=true" >> "$GITHUB_ENV"
            echo "Version type: Beta Pre-release"
          else
            echo "Tag format not supported for publishing. Skip."
            echo "SHOULD_PUBLISH=false" >> "$GITHUB_ENV"
          fi

      # 验证：被打标签的提交是否包含在期望的 version 分支中
      - name: Verify tag commit is contained in expected version branch
        if: env.SHOULD_PUBLISH == 'true'
        run: |
          set -e
          git fetch origin "+refs/heads/*:refs/remotes/origin/*"
          if git branch -r --contains "$GITHUB_SHA" | grep -E "origin/${EXPECTED_BRANCH}" >/dev/null; then
            echo "Commit $GITHUB_SHA is contained in ${EXPECTED_BRANCH}."
          else
            echo "Commit $GITHUB_SHA is NOT contained in ${EXPECTED_BRANCH}. Will skip publishing."
            echo "SHOULD_PUBLISH=false" >> "$GITHUB_ENV"
          fi

      # 安装 Node，并配置 npm registry（用于 npm publish 鉴权）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        if: env.SHOULD_PUBLISH == 'true'
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          cache: yarn

      # 使用 Yarn 安装依赖（项目包含 yarn.lock）
      - name: Install dependencies
        if: env.SHOULD_PUBLISH == 'true'
        run: |
          corepack enable
          yarn --version
          yarn install --frozen-lockfile

      # 读取 package.json 的 name 与 version，并检查该版本是否已发布
      # 已发布则跳过后续发布步骤，避免重复发布导致失败
      - name: Check if version already published
        id: version
        shell: bash
        if: env.SHOULD_PUBLISH == 'true'
        run: |
          PKG_NAME=$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json','utf8')).name)")
          VERSION=$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json','utf8')).version)")
          echo "Package: $PKG_NAME"
          echo "Version: $VERSION"
          if npm view "$PKG_NAME@$VERSION" version > /dev/null 2>&1; then
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            echo "Version $VERSION already exists on npm, skip publishing."
          else
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
            echo "Version $VERSION not found on npm, will publish."
          fi

      # 可选：预先运行单元测试与构建，提前暴露错误
      # 注意：npm publish 会触发 prepublishOnly（其中也会执行 test & build）
      - name: Run tests and build (optional precheck)
        if: env.SHOULD_PUBLISH == 'true' && steps.version.outputs.should_publish == 'true'
        run: |
          yarn test
          yarn build:all

      # 发布到 npm。latest/dev/beta 分别使用对应的 dist-tag。
      # 需要在项目 Secrets 配置 NPM_TOKEN（具有发布权限的 npm 令牌）。
      - name: Publish to npm
        if: env.SHOULD_PUBLISH == 'true' && steps.version.outputs.should_publish == 'true' && github.event_name == 'push'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # 使用 npm publish 以触发 prepublishOnly（包含测试与构建），并指定 tag 与访问级别
          npm publish --tag "$PUBLISH_TAG" --access public

      # 确保预发布标签的 dist-tag 指向当前 version（支持 dev 和 beta）
      - name: Ensure pre-release dist-tag
        if: env.SHOULD_PUBLISH == 'true' && (env.PUBLISH_TAG == 'dev' || env.PUBLISH_TAG == 'beta') && github.event_name == 'push'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PKG_NAME=$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json','utf8')).name)")
          VERSION=$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json','utf8')).version)")
          echo "Ensure dist-tag: ${PUBLISH_TAG} -> $VERSION"
          # 若版本已存在，也可重复设置 tag；若已指向则不变
          npm dist-tag add "$PKG_NAME@$VERSION" "$PUBLISH_TAG" || true
          npm dist-tag ls "$PKG_NAME"
